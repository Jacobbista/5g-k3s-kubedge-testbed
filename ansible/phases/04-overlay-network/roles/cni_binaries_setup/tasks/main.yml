---
- name: "CNI | Ensure k3s CNI binary directory exists"
  file:
    path: /var/lib/rancher/k3s/data/cni/bin
    state: directory
    mode: '0755'

- name: "CNI | Download and install Whereabouts binary"
  get_url:
    url: "https://github.com/k8snetworkplumbingwg/whereabouts/releases/download/v{{ whereabouts_version }}/whereabouts-amd64"
    dest: "/var/lib/rancher/k3s/data/cni/bin/whereabouts"
    mode: '0755'
    force: yes
  retries: 3
  delay: 5
  register: whereabouts_dl
  until: whereabouts_dl is succeeded

- name: "CNI | Download and install OVS CNI binary"
  get_url:
    url: "https://github.com/k8snetworkplumbingwg/ovs-cni/releases/download/v{{ ovs_cni_version }}/ovs"
    dest: "/var/lib/rancher/k3s/data/cni/bin/ovs"
    mode: '0755'
    force: yes
  retries: 3
  delay: 5
  register: ovs_dl
  until: ovs_dl is succeeded

- name: "CNI | Ensure /opt/cni/bin exists and install base plugins for kubelet"
  shell: |
    set -e
    mkdir -p /opt/cni/bin
    for p in flannel portmap bandwidth bridge host-local loopback static; do
      # remove dangling symlink if present before copying
      [ -L /opt/cni/bin/$p ] && rm -f /opt/cni/bin/$p || true
      if [ -f /var/lib/rancher/k3s/data/cni/$p ]; then
        install -m 0755 -D /var/lib/rancher/k3s/data/cni/$p /opt/cni/bin/$p
      elif [ -f /var/lib/rancher/k3s/data/cni/bin/$p ]; then
        install -m 0755 -D /var/lib/rancher/k3s/data/cni/bin/$p /opt/cni/bin/$p
      elif [ -f /var/lib/rancher/k3s/data/current/bin/$p ]; then
        install -m 0755 -D /var/lib/rancher/k3s/data/current/bin/$p /opt/cni/bin/$p
      fi
    done
    # Copy ovs and whereabouts into /opt/cni/bin as real files (avoid dangling symlinks in Multus pod)
    if [ -f /var/lib/rancher/k3s/data/cni/bin/ovs ]; then 
      [ -L /opt/cni/bin/ovs ] && rm -f /opt/cni/bin/ovs || true
      install -m 0755 -D /var/lib/rancher/k3s/data/cni/bin/ovs /opt/cni/bin/ovs
    fi
    if [ -f /var/lib/rancher/k3s/data/cni/bin/whereabouts ]; then 
      [ -L /opt/cni/bin/whereabouts ] && rm -f /opt/cni/bin/whereabouts || true
      install -m 0755 -D /var/lib/rancher/k3s/data/cni/bin/whereabouts /opt/cni/bin/whereabouts
    fi
  changed_when: true

- name: "CNI | Also ensure base plugins present in /var/lib/rancher/k3s/data/cni (CRI binDir)"
  shell: |
    set -e
    mkdir -p /var/lib/rancher/k3s/data/cni
    for p in flannel portmap bandwidth bridge host-local loopback static; do
      # remove dangling symlink if present before copying
      [ -L /var/lib/rancher/k3s/data/cni/$p ] && rm -f /var/lib/rancher/k3s/data/cni/$p || true
      if [ -f /var/lib/rancher/k3s/data/cni/$p ]; then
        true
      elif [ -f /var/lib/rancher/k3s/data/cni/bin/$p ]; then
        install -m 0755 -D /var/lib/rancher/k3s/data/cni/bin/$p /var/lib/rancher/k3s/data/cni/$p
      elif [ -f /var/lib/rancher/k3s/data/current/bin/$p ]; then
        install -m 0755 -D /var/lib/rancher/k3s/data/current/bin/$p /var/lib/rancher/k3s/data/cni/$p
      elif [ -f /opt/cni/bin/$p ]; then
        install -m 0755 -D /opt/cni/bin/$p /var/lib/rancher/k3s/data/cni/$p
      fi
    done
  changed_when: true

- name: "CNI | Replace broken symlinks in k3s current/bin with real binaries"
  shell: |
    set -e
    for p in flannel portmap bandwidth bridge host-local loopback static; do
      if [ -L /var/lib/rancher/k3s/data/current/bin/$p ]; then
        rm -f /var/lib/rancher/k3s/data/current/bin/$p
        if [ -f /opt/cni/bin/$p ]; then
          install -m 0755 -D /opt/cni/bin/$p /var/lib/rancher/k3s/data/current/bin/$p
        elif [ -f /var/lib/rancher/k3s/data/cni/$p ]; then
          install -m 0755 -D /var/lib/rancher/k3s/data/cni/$p /var/lib/rancher/k3s/data/current/bin/$p
        fi
      fi
    done
  changed_when: true

- name: "CNI | Ensure static IPAM plugin present (fallback to download if missing)"
  shell: |
    set -e
    if [ ! -f /opt/cni/bin/static ]; then
      TMPDIR=$(mktemp -d)
      VERSION="${CNI_PLUGINS_VERSION:-1.5.1}"
      ARCH="amd64"
      URL="https://github.com/containernetworking/plugins/releases/download/v${VERSION}/cni-plugins-linux-${ARCH}-v${VERSION}.tgz"
      curl -fsSL -o "$TMPDIR/cni.tgz" "$URL"
      tar -xzf "$TMPDIR/cni.tgz" -C "$TMPDIR"
      install -m 0755 -D "$TMPDIR/static" /opt/cni/bin/static
      rm -rf "$TMPDIR"
    fi
  changed_when: false

- name: "CNI | Verify base plugins present in /opt/cni/bin"
  shell: ls -1 /opt/cni/bin | egrep "^(flannel|portmap|bandwidth|bridge|host-local|loopback|static)$" | sort
  register: cni_opt_list
  changed_when: false

- name: "CNI | Show /opt/cni/bin base plugins"
  debug:
    var: cni_opt_list.stdout_lines
