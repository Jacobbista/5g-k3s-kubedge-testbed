---
- name: Check if k3s node
  stat:
    path: /var/lib/rancher/k3s
  register: k3s_present

- name: Set CNI paths
  set_fact:
    is_k3s_node: "{{ k3s_present.stat.exists }}"
    cni_download_dir: "{{ '/var/lib/rancher/k3s/data/cni/bin' if k3s_present.stat.exists else '/opt/cni/bin' }}"

- name: Ensure CNI binary directory
  file:
    path: "{{ cni_download_dir }}"
    state: directory
    mode: "0755"

- name: Download Whereabouts
  get_url:
    url: "https://github.com/k8snetworkplumbingwg/whereabouts/releases/download/v{{ whereabouts_version }}/whereabouts-amd64"
    dest: "{{ cni_download_dir }}/whereabouts"
    mode: "0755"
  retries: 3
  delay: 3

- name: Download OVS CNI
  get_url:
    url: "https://github.com/k8snetworkplumbingwg/ovs-cni/releases/download/v{{ ovs_cni_version }}/ovs"
    dest: "{{ cni_download_dir }}/ovs"
    mode: "0755"
  retries: 3
  delay: 3

- name: Create temp directory for CNI extraction
  file:
    path: /tmp/cni-extract
    state: directory

- name: Download and extract static plugin
  unarchive:
    src: "https://github.com/containernetworking/plugins/releases/download/v{{ cni_plugins_version }}/cni-plugins-linux-amd64-v{{ cni_plugins_version }}.tgz"
    dest: /tmp/cni-extract
    remote_src: yes

- name: Install static plugin
  copy:
    src: /tmp/cni-extract/static
    dest: "{{ cni_download_dir }}/static"
    mode: "0755"
    remote_src: yes

- name: Install macvlan plugin (for physical RAN integration)
  copy:
    src: /tmp/cni-extract/macvlan
    dest: "{{ cni_download_dir }}/macvlan"
    mode: "0755"
    remote_src: yes

- name: Create k3s symlinks
  when: is_k3s_node | bool
  file:
    src: "{{ cni_download_dir }}/{{ item }}"
    dest: "/var/lib/rancher/k3s/data/cni/{{ item }}"
    state: link
    force: yes
  loop:
    - whereabouts
    - ovs
    - static
    - macvlan

- name: Download standard CNI plugins for edge
  when: not (is_k3s_node | bool)
  unarchive:
    src: "https://github.com/containernetworking/plugins/releases/download/v{{ cni_plugins_version }}/cni-plugins-linux-amd64-v{{ cni_plugins_version }}.tgz"
    dest: /opt/cni/bin
    remote_src: yes
    creates: /opt/cni/bin/bridge
