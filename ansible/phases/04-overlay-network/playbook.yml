- name: "PHASE 4 | Install CNI binaries"
  hosts: all:!masters:!ansible
  become: yes
  roles:
    - roles/cni_binaries_setup

- name: "PHASE 4 | Setup OVS overlay"
  hosts: masters
  become: yes
  tags:
    - phase4
    - overlay
  roles:
    - roles/ovs_network_setup

- name: "PHASE 4 | Install Multus + NADs"
  hosts: masters
  become: yes
  tags:
    - multus
    - nad
  roles:
    - roles/multus_install

- name: "PHASE 4 | Setup Per-Cell Networks"
  hosts: masters
  become: no
  tags:
    - phase4
    - cell_networks
  roles:
    - roles/cell_network_setup

- name: "PHASE 4 | Verify"
  hosts: masters
  become: yes
  tasks:
    - name: Multus worker DS ready
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: DaemonSet
        name: multus-worker
        namespace: kube-system
        kubeconfig: "/home/vagrant/kubeconfig"
      register: multus_worker_info
      until: (multus_worker_info.resources|length)>0 and (multus_worker_info.resources.0.status.numberReady|int) >= 1
      retries: 24
      delay: 5

    - name: Multus edge DS ready
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: DaemonSet
        name: multus-edge
        namespace: kube-system
        kubeconfig: "/home/vagrant/kubeconfig"
      register: multus_edge_info
      until: (multus_edge_info.resources|length)>0 and (multus_edge_info.resources.0.status.numberReady|int) >= 1
      retries: 24
      delay: 5

    - name: OVS DS present and running
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: DaemonSet
        namespace: kube-system
        kubeconfig: "/home/vagrant/kubeconfig"
      register: ds_all
    - assert:
        that:
          - (ds_all.resources | selectattr('metadata.name','match','^ds-net-setup-(worker|edge)$') | list | length) == 2
          - (ds_all.resources | selectattr('metadata.name','match','^ds-net-setup-(worker|edge)$') | map(attribute='status.numberReady') | map('int') | sum) == 2

    - name: NADs present
      kubernetes.core.k8s_info:
        api_version: k8s.cni.cncf.io/v1
        kind: NetworkAttachmentDefinition
        kubeconfig: "/home/vagrant/kubeconfig"
      register: nads_info
    - assert:
        that:
          - nads_info.resources | length >= 6
