#!/usr/bin/env bash
set -euo pipefail

STATE_DIR="{{ watchdog_state_dir }}"
STATE_FILE="${STATE_DIR}/state"
mkdir -p "${STATE_DIR}"

# Pick service name dynamically
if systemctl list-unit-files | grep -q '^k3s\.service'; then
  K3S_SVC="k3s"
elif systemctl list-unit-files | grep -q '^k3s-agent\.service'; then
  K3S_SVC="k3s-agent"
else
  K3S_SVC="" # no k3s service on this node
fi

find_ctr() {
  if command -v ctr >/dev/null 2>&1; then
    echo "$(command -v ctr)"; return
  fi
  CANDIDATE="$(/usr/bin/find /var/lib/rancher/k3s/data -type f -name ctr 2>/dev/null | head -n1 || true)"
  if [ -n "${CANDIDATE:-}" ]; then echo "${CANDIDATE}"; return; fi
  echo ""
}

# Template-driven flags (evaluated at runtime in Bash)
MANAGE_RESTART="{% if watchdog_manage_restart %}true{% else %}false{% endif %}"
HTTP_ONLY="{% if watchdog_http_only %}true{% else %}false{% endif %}"
RESTART_CONTAINERD="{% if watchdog_restart_containerd %}true{% else %}false{% endif %}"
CONTAINERD_SVC="{{ watchdog_containerd_service }}"
TEST_IMAGE="{{ watchdog_test_image }}"

test_pull() {
  if [ "${HTTP_ONLY}" = "true" ]; then
    # HTTP probes only
    curl -fsS --max-time 12 "https://auth.docker.io/token?service=registry.docker.io&scope=repository:library/busybox:pull" >/dev/null || return 1
    curl -fsSI --max-time 10 https://registry-1.docker.io/v2/ | grep -qi '^www-authenticate: Bearer' || return 1
    return 0
  else
    local ctr_bin
    ctr_bin="$(find_ctr)"
    if [ -n "${ctr_bin}" ]; then
      timeout 40s "${ctr_bin}" -n k8s.io images pull "${TEST_IMAGE}" >/dev/null 2>&1 && return 0
      return 1
    else
      curl -fsS --max-time 12 "https://auth.docker.io/token?service=registry.docker.io&scope=repository:library/busybox:pull" >/dev/null || return 1
      curl -fsSI --max-time 10 https://registry-1.docker.io/v2/ | grep -qi '^www-authenticate: Bearer' || return 1
      return 0
    fi
  fi
}

FAILS=0
if [ -f "${STATE_FILE}" ]; then FAILS="$(cat "${STATE_FILE}" 2>/dev/null || echo 0)"; fi

if test_pull; then
  echo 0 > "${STATE_FILE}"
  echo "[watchdog] pull OK — counter reset" | systemd-cat -t {{ watchdog_service_name }} -p info
  exit 0
else
  FAILS=$((FAILS + 1))
  echo "${FAILS}" > "${STATE_FILE}"
  echo "[watchdog] pull FAILED (consecutive=${FAILS})" | systemd-cat -t {{ watchdog_service_name }} -p warning
fi

THRESHOLD="${THRESHOLD:-{{ watchdog_threshold }}}"
if [ "${FAILS}" -ge "${THRESHOLD}" ]; then
  if [ "${MANAGE_RESTART}" = "true" ]; then
    if [ -n "${K3S_SVC}" ]; then
      echo "[watchdog] restarting ${K3S_SVC} after ${FAILS} consecutive failures" | systemd-cat -t {{ watchdog_service_name }} -p err
      echo 0 > "${STATE_FILE}"
      systemctl restart "${K3S_SVC}"
    elif [ "${RESTART_CONTAINERD}" = "true" ]; then
      echo "[watchdog] restarting ${CONTAINERD_SVC} (no k3s service) after ${FAILS} failures" | systemd-cat -t {{ watchdog_service_name }} -p err
      echo 0 > "${STATE_FILE}"
      systemctl restart "${CONTAINERD_SVC}"
    else
      echo "[watchdog] threshold reached but no restart target configured — logging only" | systemd-cat -t {{ watchdog_service_name }} -p warning
    fi
  else
    echo "[watchdog] threshold reached — restart disabled by config (watchdog_manage_restart=false)" | systemd-cat -t {{ watchdog_service_name }} -p warning
  fi
fi


