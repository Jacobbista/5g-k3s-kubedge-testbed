---
# Install and enable a systemd watchdog that auto-restarts k3s/k3s-agent
# if image pulls to docker.io fail repeatedly.

- name: Ensure watchdog dirs exist
  file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - /usr/local/sbin
    - /var/lib/k3s-pull-watchdog

- name: Install watchdog script
  template:
    src: k3s-pull-watchdog.sh.j2
    dest: "{{ watchdog_script_path }}"
    mode: "0755"

- name: Install systemd service unit
  template:
    src: k3s-pull-watchdog.service.j2
    dest: "/etc/systemd/system/{{ watchdog_service_name }}.service"
    mode: "0644"

- name: Install systemd timer unit
  template:
    src: k3s-pull-watchdog.timer.j2
    dest: "/etc/systemd/system/{{ watchdog_service_name }}.timer"
    mode: "0644"

- name: Reload systemd and enable timer
  systemd:
    daemon_reload: yes
    name: "{{ watchdog_service_name }}.timer"
    enabled: yes
    state: started
