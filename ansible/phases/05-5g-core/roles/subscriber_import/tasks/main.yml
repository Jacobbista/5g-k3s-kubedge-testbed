---
# Import Open5GS subscribers into MongoDB using an in-cluster Job (Python + pymongo), script via ConfigMap

- name: Read subscribers JSON from role directory (controller)
  slurp:
    src: "{{ role_path }}/subscribers/subscribers.json"
  register: subs_json
  run_once: true
  delegate_to: localhost

- name: Compute checksum for idempotent names
  set_fact:
    subs_checksum: "{{ (subs_json.content | b64decode) | hash('sha1') }}"
  run_once: true

# Accept both shapes: { "subscribers": [...] } or directly [...]
- name: Parse subscribers JSON and extract array
  set_fact:
    subs_array: >-
      {{
        (subs_json.content | b64decode | from_json).subscribers
        | default((subs_json.content | b64decode | from_json), true)
      }}
  run_once: true

# Optional: wait for MongoDB to be ready (1 pod Ready with label app=mongodb)
- name: Wait for MongoDB pod Ready
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: 5g
    label_selectors: ["app=mongodb"]
    kubeconfig: "/home/vagrant/kubeconfig"
  register: mongo_pods
  retries: 30
  delay: 2
  until: >
    (mongo_pods.resources | length) > 0 and
    (
      (mongo_pods.resources[0].status.containerStatuses is defined) and
      (
        mongo_pods.resources[0].status.containerStatuses | selectattr('ready') | list | length
      ) >= 1
    )

- name: Create ConfigMap with subscribers JSON
  kubernetes.core.k8s:
    api_version: v1
    kind: ConfigMap
    name: "subscribers-json-{{ subs_checksum }}"
    namespace: 5g
    state: present
    definition:
      metadata:
        labels:
          app.kubernetes.io/name: subscriber-import
          app.kubernetes.io/component: bootstrap
      data:
        subs.json: "{{ subs_array | to_json }}"
    kubeconfig: "/home/vagrant/kubeconfig"

- name: Create ConfigMap with importer script
  kubernetes.core.k8s:
    api_version: v1
    kind: ConfigMap
    name: "subscriber-importer-script-{{ subs_checksum }}"
    namespace: 5g
    state: present
    definition:
      metadata:
        labels:
          app.kubernetes.io/name: subscriber-import
          app.kubernetes.io/component: bootstrap
      data:
        import_subscribers.py: "{{ lookup('template', role_path + '/templates/import_subscribers.py.j2') }}"
    kubeconfig: "/home/vagrant/kubeconfig"

- name: Get existing subscriber import Jobs
  kubernetes.core.k8s_info:
    api_version: batch/v1
    kind: Job
    namespace: 5g
    kubeconfig: "/home/vagrant/kubeconfig"
  register: existing_jobs

- name: Build stale subscriber import Job list
  set_fact:
    stale_sub_import_jobs: >-
      {{
        existing_jobs.resources
        | map(attribute='metadata.name')
        | select('match', '^sub-import-')
        | reject('equalto', 'sub-import-' ~ subs_checksum)
        | list
      }}

- name: Delete stale subscriber import Jobs
  kubernetes.core.k8s:
    api_version: batch/v1
    kind: Job
    name: "{{ item }}"
    namespace: 5g
    state: absent
    kubeconfig: "/home/vagrant/kubeconfig"
  loop: "{{ stale_sub_import_jobs }}"
  loop_control:
    label: "{{ item }}"

- name: Delete previous import Job (fresh run)
  kubernetes.core.k8s:
    api_version: batch/v1
    kind: Job
    name: "sub-import-{{ subs_checksum }}"
    namespace: 5g
    state: absent
    kubeconfig: "/home/vagrant/kubeconfig"

- name: Get existing subscriber import pods
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: 5g
    kubeconfig: "/home/vagrant/kubeconfig"
  register: existing_sub_import_pods

- name: Build stale subscriber import pod list
  set_fact:
    stale_sub_import_pods: >-
      {{
        existing_sub_import_pods.resources
        | map(attribute='metadata.name')
        | select('match', '^sub-import-')
        | list
      }}

- name: Delete stale subscriber import pods
  kubernetes.core.k8s:
    api_version: v1
    kind: Pod
    name: "{{ item }}"
    namespace: 5g
    state: absent
    kubeconfig: "/home/vagrant/kubeconfig"
  loop: "{{ stale_sub_import_pods }}"
  loop_control:
    label: "{{ item }}"

- name: Create Job to import subscribers into MongoDB (Python + pymongo)
  kubernetes.core.k8s:
    api_version: batch/v1
    kind: Job
    name: "sub-import-{{ subs_checksum }}"
    namespace: 5g
    state: present
    definition:
      metadata:
        labels:
          app.kubernetes.io/name: subscriber-import
          app.kubernetes.io/component: bootstrap
      spec:
        backoffLimit: 0
        ttlSecondsAfterFinished: 300
        template:
          metadata:
            labels:
              app: subscriber-import
              app.kubernetes.io/name: subscriber-import
              app.kubernetes.io/component: bootstrap
          spec:
            nodeSelector:
              kubernetes.io/hostname: worker
            restartPolicy: Never
            containers:
              - name: importer
                image: python:3.11-slim
                imagePullPolicy: IfNotPresent
                command: ["bash", "-lc"]
                args:
                  - |
                    set -euo pipefail
                    python -m pip install --no-cache-dir -q "pymongo>=3.12,<4"
                    python /script/import_subscribers.py
                env:
                  - name: MONGO_URI
                    value: "mongodb://mongodb:27017/open5gs"
                  - name: SUBS_FILE
                    value: "/work/subs.json"
                volumeMounts:
                  - name: subs
                    mountPath: /work
                  - name: script
                    mountPath: /script
            volumes:
              - name: subs
                configMap:
                  name: "subscribers-json-{{ subs_checksum }}"
              - name: script
                configMap:
                  name: "subscriber-importer-script-{{ subs_checksum }}"
    kubeconfig: "/home/vagrant/kubeconfig"

# Wait until the Job either succeeds or fails, then surface logs on failure
- name: Wait for Job condition (Complete/Failed)
  kubernetes.core.k8s_info:
    api_version: batch/v1
    kind: Job
    name: "sub-import-{{ subs_checksum }}"
    namespace: 5g
    kubeconfig: "/home/vagrant/kubeconfig"
  register: job_info
  retries: 20
  delay: 3
  until: >
    job_info.resources | length > 0 and (
      (job_info.resources[0].status.succeeded | default(0) | int) >= 1 or
      (job_info.resources[0].status.failed | default(0) | int) >= 1
    )

- name: Get Job pods
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: 5g
    label_selectors: ["job-name=sub-import-{{ subs_checksum }}"]
    kubeconfig: "/home/vagrant/kubeconfig"
  register: job_pods

- name: Print Job logs on failure
  when: (job_info.resources[0].status.succeeded | default(0) | int) < 1
  command: >
    kubectl --kubeconfig=/home/vagrant/kubeconfig -n 5g
    logs {{ job_pods.resources[0].metadata.name }} -c importer --tail=200
  register: job_logs
  changed_when: false

- name: Fail if Job failed
  when: (job_info.resources[0].status.succeeded | default(0) | int) < 1
  fail:
    msg: |
      Subscriber import Job failed.
      --- POD LOGS ---
      {{ job_logs.stdout }}
