{% for cell in ueransim_topology.cells %}
{% set ue_count = (cell.ues | length) %}
{% if ue_count > 0 %}
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: ue-cell-{{ cell.id }}
  namespace: {{ namespace }}
  labels:
    app: ue
    cell-id: "{{ cell.id }}"
spec:
  serviceName: ue-cell-{{ cell.id }}
  replicas: {{ ue_count }}
  selector:
    matchLabels:
      app: ue
      cell-id: "{{ cell.id }}"
  template:
    metadata:
      labels:
        app: ue
        cell-id: "{{ cell.id }}"
      annotations:
        k8s.v1.cni.cncf.io/networks: |
          [ {"name": "n2-cell-{{ cell.id }}", "interface": "n2"} ]
    spec:
      nodeSelector:
        kubernetes.io/hostname: {{ (cell.ues[0].node | default(ueransim_topology.defaults.node_defaults.ue)) if ue_count>0 else (ueransim_topology.defaults.node_defaults.ue) }}
      # WORKAROUND: EdgeCore doesn't have access to CoreDNS
      # See roles/endpoints_sync/README.md for proper long-term solution
      # TODO: Configure EdgeCore to use cluster CoreDNS and remove this
      hostAliases:
        - ip: "10.202.1.10"  # gNB N2 IP (hardcoded - must match gnb-endpoints-sync output)
          hostnames:
            - "{{ cell.gnb.name }}.{{ namespace }}.svc.cluster.local"
      volumes:
        - name: ue-config-runtime
          emptyDir: {}
      initContainers:
        - name: config-gen
          image: {{ ueransim_topology.defaults.image }}
          imagePullPolicy: IfNotPresent
          command: ["/bin/bash", "-c"]
          args:
            - |
              set -euo pipefail
              ORD=${HOSTNAME##*-}
              # Arrays rendered from topology
              SUPIS=({% for ue in cell.ues %} "imsi-00101123456{{ ue.supi_suffix }}"{% if not loop.last %} {% endif %}{% endfor %})
              APNS=({% for ue in cell.ues %} "{{ ue.apn }}"{% if not loop.last %} {% endif %}{% endfor %})
              SST=({% for ue in cell.ues %} "{{ ue.slice.sst }}"{% if not loop.last %} {% endif %}{% endfor %})
              SD=({% for ue in cell.ues %} "{{ ue.slice.sd }}"{% if not loop.last %} {% endif %}{% endfor %})
              SUPI=${SUPIS[$ORD]}
              APN=${APNS[$ORD]}
              UE_CFG=/UERANSIM/config/ue-${ORD}.yaml
              cat > "$UE_CFG" <<EOF
              supi: "$SUPI"
              mcc: "{{ ueransim_topology.defaults.mcc }}"
              mnc: "{{ ueransim_topology.defaults.mnc }}"
              protectionScheme: 0
              homeNetworkPublicKey: "5a8d38864820197c3394b92613b20b91633cbd897119273bf8e4a6f4eec0a650"
              homeNetworkPublicKeyId: 1
              routingIndicator: "0000"
              key: "{{ ueransim_topology.defaults.key_template }}"
              op: "{{ ueransim_topology.defaults.op }}"
              opType: "OP"
              amf: "8000"
              imei: "356938035643803"
              imeiSv: "4370816125816151"
              tunNetmask: "255.255.255.0"
              gnbSearchList:
                - {{ cell.gnb.name }}.{{ namespace }}.svc.cluster.local
              uacAic:
                mps: false
                mcs: false
              uacAcc:
                normalClass: 0
                class11: false
                class12: false
                class13: false
                class14: false
                class15: false
              sessions:
                - type: "IPv4"
                  apn: "$APN"
                  slice:
                    sst: ${SST[$ORD]}
                    sd: ${SD[$ORD]}
              configured-nssai:
                - sst: ${SST[$ORD]}
                  sd: ${SD[$ORD]}
              default-nssai:
                - sst: ${SST[$ORD]}
                  sd: ${SD[$ORD]}
              integrity:
                IA1: true
                IA2: true
                IA3: true
              ciphering:
                EA1: true
                EA2: true
                EA3: true
              integrityMaxRate:
                uplink: "full"
                downlink: "full"
              EOF
          volumeMounts:
            - name: ue-config-runtime
              mountPath: /UERANSIM/config
      containers:
        - name: ue
          image: {{ ueransim_topology.defaults.image }}
          imagePullPolicy: IfNotPresent
          securityContext:
            privileged: true
            capabilities:
              add: ["NET_ADMIN", "SYS_ADMIN"]
          command: ["/bin/sh", "-c"]
          args:
            - |
              ORD=${HOSTNAME##*-}
              {{ ue_binary_path }} -c /UERANSIM/config/ue-${ORD}.yaml
          volumeMounts:
            - name: ue-config-runtime
              mountPath: /UERANSIM/config
          startupProbe:
            exec: { command: ["pgrep", "-f", "nr-ue"] }
            initialDelaySeconds: 5
            periodSeconds: 5
            failureThreshold: 60
          livenessProbe:
            exec:
              command: ["pgrep", "-f", "nr-ue"]
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 3
          resources:
            requests:
              cpu: "200m"
              memory: "256Mi"
            limits:
              cpu: "500m"
              memory: "512Mi"
{% endif %}
{% endfor %}


