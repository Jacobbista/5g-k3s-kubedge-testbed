{% for cell in ueransim_topology.cells %}
{% set ue_count = (cell.ues | length) %}
{% if ue_count > 0 %}
---
# UE StatefulSet for cell {{ cell.id }}
# Uses dynamic gNB discovery via K8s API query at startup.
# This allows UE to auto-configure even if gNB restarts with a new IP.
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: ue-cell-{{ cell.id }}
  namespace: {{ namespace }}
  labels:
    app: ue
    component: ue
    cell-id: "{{ cell.id }}"
spec:
  serviceName: ue-cell-{{ cell.id }}
  replicas: {{ ue_count }}
  selector:
    matchLabels:
      app: ue
      cell-id: "{{ cell.id }}"
  template:
    metadata:
      labels:
        app: ue
        component: ue
        cell-id: "{{ cell.id }}"
      annotations:
        k8s.v1.cni.cncf.io/networks: |
          [ {"name": "n2-cell-{{ cell.id }}", "interface": "n2"} ]
    spec:
      # Disable auto-mount of ServiceAccount token - KubeEdge can't handle
      # projected token volumes on edge nodes (causes "length error")
      automountServiceAccountToken: false
      nodeSelector:
        kubernetes.io/hostname: {{ (cell.ues[0].node | default(ueransim_topology.defaults.node_defaults.ue)) if ue_count>0 else (ueransim_topology.defaults.node_defaults.ue) }}
      volumes:
        - name: ue-config-runtime
          emptyDir: {}
      initContainers:
        # Discover gNB IP via K8s API
        # Token is passed as env var because KubeEdge doesn't sync ConfigMaps/Secrets to edge nodes
        - name: gnb-discovery
          image: nicolaka/netshoot:latest
          imagePullPolicy: IfNotPresent
          securityContext:
            capabilities:
              add: ["NET_ADMIN"]
          env:
            - name: K8S_API
              value: "https://{{ k8s_api_server }}"
            - name: NAMESPACE
              value: "{{ namespace }}"
            - name: GNB_NAME
              value: "{{ cell.gnb.name }}"
            - name: DISCOVERY_TOKEN
              value: "{{ discovery_token }}"
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -e
              # Add default route via eth0 gateway (needed on KubeEdge edge nodes)
              DEFAULT_GW=$(ip route | grep -E '^10\.[0-9]+\.[0-9]+\.0/24 dev eth0' | sed 's|.*/24.*||;s|.*\.||')
              ETH0_NET=$(ip route | grep -E '^10\.[0-9]+\.[0-9]+\.0/24 dev eth0' | awk '{print $1}' | sed 's|\.0/24||')
              if [ -n "$ETH0_NET" ] && ! ip route | grep -q "^default"; then
                ip route add default via ${ETH0_NET}.1 dev eth0 2>/dev/null || true
              fi
              
              echo "Discovering gNB ${GNB_NAME} N2 IP..."
              
              for i in $(seq 1 10); do
                # Query gNB pod
                RESP=$(curl -sk -H "Authorization: Bearer $DISCOVERY_TOKEN" \
                  "${K8S_API}/api/v1/namespaces/${NAMESPACE}/pods?labelSelector=app=${GNB_NAME}" 2>/dev/null || echo "{}")
                
                # Use jq to parse network-status annotation and find n2 interface IP
                GNB_IP=$(echo "$RESP" | jq -r '
                  .items[0].metadata.annotations["k8s.v1.cni.cncf.io/network-status"] // empty
                  | fromjson
                  | .[] | select(.interface == "n2") | .ips[0] // empty
                ' 2>/dev/null || echo "")
                
                if [ -n "$GNB_IP" ] && [ "$GNB_IP" != "null" ]; then
                  echo "Found gNB N2 IP: $GNB_IP"
                  echo "$GNB_IP" > /config/gnb-ip
                  exit 0
                fi
                echo "Waiting for gNB... (attempt $i/10)"
                sleep 2
              done
              echo "ERROR: Could not discover gNB IP after 10 attempts"
              exit 1
          volumeMounts:
            - name: ue-config-runtime
              mountPath: /config
        # Generate UE config with discovered gNB IP
        # Also waits for Multus interface to be ready (race condition fix)
        - name: config-gen
          image: {{ ueransim_topology.defaults.image }}
          imagePullPolicy: IfNotPresent
          command: ["/bin/bash", "-c"]
          args:
            - |
              set -euo pipefail
              
              # Wait for Multus network interface to be ready
              echo "Waiting for network interface (n2)..."
              for i in $(seq 1 30); do
                N2_READY=$(ip addr show n2 2>/dev/null | grep -c "inet " || echo 0)
                if [ "$N2_READY" -gt 0 ]; then
                  echo "Network interface ready:"
                  ip -br addr show n2
                  break
                fi
                echo "Waiting for n2 interface... (attempt $i/30)"
                sleep 1
              done
              
              ORD=${HOSTNAME##*-}
              GNB_IP=$(cat /UERANSIM/config/gnb-ip)
              echo "Generating UE config with gNB IP: $GNB_IP"
              
              # Arrays rendered from topology
              SUPIS=({% for ue in cell.ues %} "imsi-{{ ueransim_topology.defaults.mcc }}{{ ueransim_topology.defaults.mnc }}{{ ueransim_topology.defaults.imsi_msin_base }}{{ ue.supi_suffix }}"{% if not loop.last %} {% endif %}{% endfor %})
              APNS=({% for ue in cell.ues %} "{{ ue.apn }}"{% if not loop.last %} {% endif %}{% endfor %})
              SST=({% for ue in cell.ues %} "{{ ue.slice.sst }}"{% if not loop.last %} {% endif %}{% endfor %})
              SD=({% for ue in cell.ues %} "{{ ue.slice.sd }}"{% if not loop.last %} {% endif %}{% endfor %})
              SUPI=${SUPIS[$ORD]}
              APN=${APNS[$ORD]}
              UE_CFG=/UERANSIM/config/ue-${ORD}.yaml
              cat > "$UE_CFG" <<EOF
              supi: "$SUPI"
              mcc: "{{ ueransim_topology.defaults.mcc }}"
              mnc: "{{ ueransim_topology.defaults.mnc }}"
              protectionScheme: 0
              homeNetworkPublicKey: "5a8d38864820197c3394b92613b20b91633cbd897119273bf8e4a6f4eec0a650"
              homeNetworkPublicKeyId: 1
              routingIndicator: "0000"
              key: "{{ ueransim_topology.defaults.key_template }}"
              op: "{{ ueransim_topology.defaults.op }}"
              opType: "OP"
              amf: "8000"
              imei: "356938035643803"
              imeiSv: "4370816125816151"
              tunNetmask: "255.255.255.0"
              gnbSearchList:
                - $GNB_IP
              uacAic:
                mps: false
                mcs: false
              uacAcc:
                normalClass: 0
                class11: false
                class12: false
                class13: false
                class14: false
                class15: false
              sessions:
                - type: "IPv4"
                  apn: "$APN"
                  slice:
                    sst: ${SST[$ORD]}
                    sd: ${SD[$ORD]}
              configured-nssai:
                - sst: ${SST[$ORD]}
                  sd: ${SD[$ORD]}
              default-nssai:
                - sst: ${SST[$ORD]}
                  sd: ${SD[$ORD]}
              integrity:
                IA1: true
                IA2: true
                IA3: true
              ciphering:
                EA1: true
                EA2: true
                EA3: true
              integrityMaxRate:
                uplink: "full"
                downlink: "full"
              EOF
              echo "UE config generated for $SUPI"
          volumeMounts:
            - name: ue-config-runtime
              mountPath: /UERANSIM/config
      containers:
        - name: ue
          image: {{ ueransim_topology.defaults.image }}
          imagePullPolicy: IfNotPresent
          securityContext:
            privileged: true
            capabilities:
              add: ["NET_ADMIN", "SYS_ADMIN"]
          command: ["/bin/sh", "-c"]
          args:
            - |
              ORD=${HOSTNAME##*-}
              {{ ue_binary_path }} -c /UERANSIM/config/ue-${ORD}.yaml
          volumeMounts:
            - name: ue-config-runtime
              mountPath: /UERANSIM/config
          startupProbe:
            exec: { command: ["pgrep", "-f", "nr-ue"] }
            initialDelaySeconds: 5
            periodSeconds: 5
            failureThreshold: 60
          livenessProbe:
            exec:
              command: ["pgrep", "-f", "nr-ue"]
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 3
          resources:
            requests:
              cpu: "200m"
              memory: "256Mi"
            limits:
              cpu: "500m"
              memory: "512Mi"
{% endif %}
{% endfor %}
