---
# GNB DEPLOYMENT (Deployment per cell)
# Deploy gNBs driven by ueransim_topology
#
# AMF discovery: gNB init container queries K8s API at startup to discover AMF IP.
# Uses long-lived token from discovery-token Secret (created by infrastructure_setup).
# This allows gNB to auto-configure even if AMF restarts with a new IP.

- name: Load topology vars
  include_vars:
    file: "{{ playbook_dir }}/vars/topology.yml"

# Verify AMF is running before deploying gNB (optional but recommended)
- name: Verify AMF pod exists
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: "{{ namespace }}"
    label_selectors: ["app=amf"]
    kubeconfig: "{{ kubeconfig_path }}"
  register: amf_pods_check
  delegate_to: "{{ groups['masters'][0] }}"
  run_once: true

- name: Warn if AMF not found (gNB will wait at startup)
  debug:
    msg: "WARNING: AMF pod not found. gNB will wait for AMF at startup."
  when: amf_pods_check.resources | length == 0
  run_once: true

- name: Get discovery token from ConfigMap
  kubernetes.core.k8s_info:
    api_version: v1
    kind: ConfigMap
    namespace: "{{ namespace }}"
    name: discovery-token
    kubeconfig: "{{ kubeconfig_path }}"
  register: discovery_token_cm
  delegate_to: "{{ groups['masters'][0] }}"
  run_once: true

- name: Fail if discovery-token ConfigMap not found
  fail:
    msg: "discovery-token ConfigMap not found in namespace {{ namespace }}. Run infrastructure_setup role first."
  when: discovery_token_cm.resources | length == 0
  run_once: true

- name: Extract discovery token
  set_fact:
    discovery_token: "{{ discovery_token_cm.resources[0].data.token }}"
  run_once: true

- name: Deploy gNB Services + Deployments
  kubernetes.core.k8s:
    state: present
    kubeconfig: "{{ kubeconfig_path }}"
    definition: "{{ lookup('template', 'gnb-deployment.yaml.j2') }}"
  delegate_to: "{{ groups['masters'][0] }}"
  run_once: true

- name: Wait for gNB pods ready (per cell)
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: "{{ namespace }}"
    label_selectors: ["app={{ item.gnb.name }}"]
    kubeconfig: "{{ kubeconfig_path }}"
  register: gnb_pods
  retries: 12
  delay: 5
  until: >-
    gnb_pods.resources | length > 0 and
    (gnb_pods.resources | selectattr('status.phase','equalto','Running') | list | length) >= 1
  loop: "{{ ueransim_topology.cells }}"
  loop_control:
    label: "{{ item.gnb.name }}"
  delegate_to: "{{ groups['masters'][0] }}"
  run_once: true
