---
# FASE 3: KUBEEDGE SETUP
# Setup KubeEdge cloudcore sul worker e edgecore sull'edge

- name: "FASE 3: Setup KubeEdge CloudCore on Worker"
  hosts: workers
  become: yes
  roles:
    - { role: roles/kubeedge_worker, tags: ['kubeedge', 'cloudcore', 'worker'] }

- name: "FASE 3: Setup KubeEdge EdgeCore on Edge"
  hosts: edges
  become: yes
  roles:
    - { role: roles/kubeedge_edge, tags: ['kubeedge', 'edgecore', 'edge'] }

- name: "FASE 3: Verify KubeEdge Integration"
  hosts: masters
  become: yes
  tags:
    - verify
  tasks:
    - name: "KubeEdge | Verify edge node is registered"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Node
        name: "{{ hostvars[groups['edges'][0]]['inventory_hostname'] }}"
        kubeconfig: "/home/vagrant/kubeconfig"
      register: edge_node_info

    - name: "KubeEdge | Verify KubeEdge namespace pods"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: kubeedge
        kubeconfig: "/home/vagrant/kubeconfig"
      register: kubeedge_pods_info

    - name: "KubeEdge | Display KubeEdge integration status"
      debug:
        msg: |
          âœ… KubeEdge Integration Complete
          ðŸ“Š Edge Node: {{ edge_node_info.resources[0].metadata.name }} ({{ edge_node_info.resources[0].status.conditions | selectattr('type', 'equalto', 'Ready') | map(attribute='status') | first }})
          ðŸ“¦ KubeEdge Pods: {{ kubeedge_pods_info.resources | length }}
          {% for pod in kubeedge_pods_info.resources %}
          - {{ pod.metadata.name }}: {{ pod.status.phase }}
          {% endfor %}
