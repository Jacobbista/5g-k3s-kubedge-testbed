# PHASE 3: KubeEdge Setup

- name: "PHASE 3 | CloudCore on worker"
  hosts: workers
  become: yes
  roles:
    - roles/kubeedge_common
    - roles/kubeedge_cloudcore

- name: "PHASE 3 | EdgeCore on edge"
  hosts: edges
  become: yes
  roles:
    - roles/edge_containerd
    - roles/kubeedge_common
    - roles/kubeedge_edgecore

- name: "PHASE 3 | Verify"
  hosts: masters
  become: yes
  tasks:
    - name: Ensure kubeedge namespace exists
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata: { name: kubeedge }
        kubeconfig: "/home/vagrant/kubeconfig"

    - name: Get CloudCore pod(s)
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: kubeedge
        kubeconfig: "/home/vagrant/kubeconfig"
      register: ke_pods

    - name: Assert CloudCore Running
      assert:
        that:
          - (ke_pods.resources | selectattr('status.phase','equalto','Running') | list | length) >= 1
        fail_msg: "CloudCore not running"

    - name: Check Edge node object
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Node
        name: "{{ groups['edges'][0] }}"
        kubeconfig: "/home/vagrant/kubeconfig"
      register: edge_node

    - name: Show KubeEdge status
      debug:
        msg:
          - "Edge node: {{ edge_node.resources | length | ternary(edge_node.resources[0].metadata.name, 'not found') }}"
          - "CloudCore pods (kubeedge): {{ ke_pods.resources | map(attribute='metadata.name') | list }}"
