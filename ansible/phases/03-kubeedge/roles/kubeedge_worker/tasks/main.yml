---
# KUBEEDGE WORKER NODE SETUP (CLOUDCORE)
# Installa KubeEdge cloudcore sul worker node

- name: "KubeEdge | Copy kubeconfig from master to worker"
  slurp:
    src: /home/vagrant/kubeconfig
  delegate_to: "{{ hostvars[groups['masters'][0]]['inventory_hostname'] }}"
  run_once: true
  register: kubeconfig_content

- name: "KubeEdge | Create kubeconfig on worker for cluster access"
  copy:
    content: "{{ kubeconfig_content.content | b64decode }}"
    dest: /home/vagrant/kubeconfig
    owner: vagrant
    group: vagrant
    mode: '0600'

- name: "KubeEdge | Point worker kubeconfig to master API (not 127.0.0.1)"
  replace:
    path: /home/vagrant/kubeconfig
    regexp: 'server:\s*https://[^\s]+:6443'
    replace: "server: https://{{ hostvars[groups['masters'][0]]['ansible_host'] }}:6443"

- name: "KubeEdge | Download keadm binary for cloudcore management"
  get_url:
    url: "https://github.com/kubeedge/kubeedge/releases/download/v{{ kubeedge_version }}/keadm-v{{ kubeedge_version }}-linux-amd64.tar.gz"
    dest: /tmp/keadm.tar.gz
    mode: '0644'
    force: yes
  register: keadm_dl
  retries: 5
  delay: 6
  until: keadm_dl is succeeded

- name: "KubeEdge | Extract keadm binary from archive"
  unarchive:
    src: /tmp/keadm.tar.gz
    dest: /tmp
    remote_src: true

- name: "KubeEdge | Install keadm binary to /usr/local/bin"
  copy:
    src: "/tmp/keadm-v{{ kubeedge_version }}-linux-amd64/keadm/keadm"
    dest: /usr/local/bin/keadm
    mode: '0755'
    remote_src: true

- name: "KubeEdge | Wait for k3s cluster to be stable before initializing cloudcore"
  shell: |
    echo "â³ Waiting for k3s cluster to be stable..."
    for i in $(seq 30); do
      echo -n "."
      if systemctl is-active --quiet k3s-agent; then
        echo ""
        echo "âœ… k3s agent is running! (${i}s)"
        exit 0
      fi
      sleep 2
    done
    echo ""
    echo "âŒ k3s agent not stable within 60s"
    exit 1
  register: k3s_stable
  failed_when: k3s_stable.rc != 0

- name: "KubeEdge | Remove kubeedge namespace from cluster"
  shell: |
    kubectl --kubeconfig=/home/vagrant/kubeconfig delete namespace kubeedge --ignore-not-found=true
  changed_when: false
  failed_when: false
  register: namespace_removal

- name: "KubeEdge | Reset existing cloudcore if present"
  shell: |
    /usr/local/bin/keadm reset cloud --force || true
  changed_when: false
  failed_when: false
  register: cloudcore_reset

- name: "KubeEdge | Force cleanup of cloudcore processes"
  shell: |
    pkill -f cloudcore || true
    pkill -f keadm || true
    sleep 2
  changed_when: false
  failed_when: false

- name: "KubeEdge | Check if cloudcore is already running"
  shell: |
    SEL="app=cloudcore";
    if [ "$(kubectl --kubeconfig=/home/vagrant/kubeconfig get pods -n kubeedge -l app=cloudcore --no-headers 2>/dev/null | wc -l)" -eq 0 ]; then SEL="kubeedge=cloudcore"; fi;
    if kubectl --kubeconfig=/home/vagrant/kubeconfig get pods -n kubeedge -l "$SEL" --no-headers 2>/dev/null | grep -q "Running"; then
      echo "cloudcore_running"
    else
      echo "cloudcore_not_running"
    fi
  register: cloudcore_status
  changed_when: false

- name: "KubeEdge | Wait for cleanup to complete"
  pause:
    seconds: 10

- name: Ensure reliable DNS resolvers for image pulls (worker)
  shell: |
    echo "ðŸ”§ Configuring reliable DNS resolvers..."
    cp /etc/resolv.conf /etc/resolv.conf.backup || true
    cat > /etc/resolv.conf << 'EOF'
    nameserver 8.8.8.8
    nameserver 1.1.1.1
    nameserver 8.8.4.4
    nameserver 1.0.0.1
    options timeout:2
    options attempts:3
    EOF
    nslookup registry-1.docker.io >/dev/null 2>&1 && echo OK || (echo FAIL; exit 1)
  changed_when: true

- name: "KubeEdge | Initialize cloudcore with worker IP address"
  shell: |
    /usr/local/bin/keadm init --kube-config=/home/vagrant/kubeconfig --advertise-address={{ ansible_host }} --kubeedge-version={{ kubeedge_version }} --force
  register: cloudcore_init_result
  failed_when: false
  when: cloudcore_status.stdout == "cloudcore_not_running"

- name: "KubeEdge | Check if cloudcore initialization was successful"
  fail:
    msg: "CloudCore initialization failed: {{ cloudcore_init_result.stderr }}"
  when: cloudcore_init_result.rc != 0 and "already running" not in cloudcore_init_result.stderr and "being terminated" not in cloudcore_init_result.stderr

- name: "KubeEdge | Wait for cloudcore Running via API (kubernetes.core)"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: kubeedge
    kubeconfig: "/home/vagrant/kubeconfig"
  delegate_to: "{{ groups['masters'][0] }}"
  register: kubeedge_pods_all
  retries: 36
  delay: 5
  until: >-
    ((kubeedge_pods_all.resources | selectattr('metadata.labels.app','defined')
      | selectattr('metadata.labels.app','equalto','cloudcore')
      | selectattr('status.phase','equalto','Running') | list | length) > 0)
    or
    ((kubeedge_pods_all.resources | selectattr('metadata.labels.kubeedge','defined')
      | selectattr('metadata.labels.kubeedge','equalto','cloudcore')
      | selectattr('status.phase','equalto','Running') | list | length) > 0)
  when: cloudcore_status.stdout == "cloudcore_not_running"

- name: "KubeEdge | Verify cloudcore is running"
  shell: |
    echo "ðŸ” Verifying cloudcore is running..."
    SEL="app=cloudcore";
    if [ "$(kubectl --kubeconfig=/home/vagrant/kubeconfig get pods -n kubeedge -l app=cloudcore --no-headers 2>/dev/null | wc -l)" -eq 0 ]; then SEL="kubeedge=cloudcore"; fi;
    if kubectl --kubeconfig=/home/vagrant/kubeconfig get pods -n kubeedge -l "$SEL" --no-headers 2>/dev/null | grep -q "Running"; then
      echo "âœ… Cloudcore is running"
      kubectl --kubeconfig=/home/vagrant/kubeconfig get pods -n kubeedge -l "$SEL"
    else
      echo "âŒ Cloudcore is not running"
      exit 1
    fi
  register: cloudcore_verify
  failed_when: cloudcore_verify.rc != 0

- name: "KubeEdge | Wait for tokensecret to be available (disabled - keadm will create it)"
  debug:
    msg: "Skipping explicit wait for tokensecret; using keadm gettoken with retries"
  when: false

- name: "KubeEdge | Get edge join token for edge node connection"
  shell: sudo -u vagrant /usr/local/bin/keadm gettoken --kube-config=/home/vagrant/kubeconfig
  register: edge_token
  changed_when: false
  retries: 20
  delay: 3
  until: edge_token.rc == 0 and (edge_token.stdout | length) > 0

- name: "KubeEdge | Create edge join token file for distribution"
  copy:
    content: "{{ edge_token.stdout }}"
    dest: /home/vagrant/edge_token
    owner: vagrant
    group: vagrant
    mode: '0600'

- name: "KubeEdge | Copy current config.toml as new template base"
  copy:
    src: /var/lib/rancher/k3s/agent/etc/containerd/config.toml
    dest: /var/lib/rancher/k3s/agent/etc/containerd/config.toml.tmpl
    remote_src: true
    mode: '0644'
    owner: root
    group: root
  tags:
    - setup
    - containerd
    - kubeedge

- name: "KubeEdge | Remove systemd_cgroup from CRI section (incompatible with runc.v2)"
  replace:
    path: /var/lib/rancher/k3s/agent/etc/containerd/config.toml.tmpl
    regexp: '^\s*systemd_cgroup\s*=\s*.*'
    replace: ''
  tags:
    - setup
    - containerd
    - kubeedge

- name: "KubeEdge | Ensure SystemdCgroup is enabled in runc options"
  lineinfile:
    path: /var/lib/rancher/k3s/agent/etc/containerd/config.toml.tmpl
    line: '    SystemdCgroup = true'
    insertafter: '^\s*\[plugins\."io\.containerd\.runc\.v2"\]'
    state: present
  tags:
    - setup
    - containerd
    - kubeedge

- name: "KubeEdge | Restart k3s-agent to apply containerd configuration"
  systemd:
    name: k3s-agent
    state: restarted
  tags:
    - setup
    - containerd
    - kubeedge

- name: "KubeEdge | Wait for k3s-agent to be ready after containerd config"
  wait_for:
    port: 10250
    host: "{{ ansible_host }}"
    timeout: 60
  tags:
    - setup
    - containerd
    - kubeedge

- name: "KubeEdge | Open CloudCore ports for edge communication"
  shell: |
    echo "ðŸ”“ Opening CloudCore ports for edge communication..."
    # Open port 10000 for CloudCore-EdgeCore communication
    iptables -A INPUT -p tcp --dport 10000 -j ACCEPT
    iptables -A INPUT -p udp --dport 10000 -j ACCEPT
    echo "âœ… CloudCore ports opened"
  changed_when: true
