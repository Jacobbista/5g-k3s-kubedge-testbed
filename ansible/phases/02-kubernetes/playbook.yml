# PHASE 2: Kubernetes cluster setup (K3s)

- name: "PHASE 2 | Setup k3s Master"
  hosts: masters
  become: yes
  roles:
    - roles/k3s_master

- name: "PHASE 2 | Setup k3s Agents (workers only)"
  hosts: workers
  become: yes
  roles:
    - role: roles/k3s_agent
      vars:
        node_type: "worker"

- name: "PHASE 2 | kube-proxy guard (only if missing)"
  hosts: masters
  become: yes
  roles:
    - roles/kube_proxy_guard

- name: "PHASE 2 | Smoke tests"
  hosts: masters
  become: yes
  roles:
    - roles/cluster_smoke

- name: "PHASE 2 | Verify cluster"
  hosts: masters
  become: yes
  tasks:
    - name: Wait for all Nodes Ready (master + worker)
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Node
        kubeconfig: "{{ kubeconfig_path }}"
      register: nodes
      retries: 24
      delay: 5
      until: >-
        (nodes.resources | length) >= 2 and
        (nodes.resources | selectattr('status', 'defined') | list | length) >= 2

    - name: Show nodes
      debug:
        msg: "{{ nodes.resources | map(attribute='metadata.name') | list }}"
