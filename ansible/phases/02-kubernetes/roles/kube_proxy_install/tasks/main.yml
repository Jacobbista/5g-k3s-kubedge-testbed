---
# Ensure kube-proxy is deployed (k3s sometimes excludes it if misconfigured)

- name: Check if kube-proxy pods exist
  shell: |
    export KUBECONFIG=/home/vagrant/kubeconfig
    kubectl -n kube-system get pods -l k8s-app=kube-proxy --no-headers | wc -l
  register: kp_count
  changed_when: false

- name: Apply kube-proxy DaemonSet manifest when missing
  when: kp_count.stdout | int == 0
  shell: |
    export KUBECONFIG=/home/vagrant/kubeconfig
    cat <<'EOF' | kubectl apply -f -
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: kube-proxy
      namespace: kube-system
    data:
      config.conf: |
        apiVersion: kubeproxy.config.k8s.io/v1alpha1
        kind: KubeProxyConfiguration
        mode: "iptables"
        clusterCIDR: "10.42.0.0/16"
    ---
    apiVersion: apps/v1
    kind: DaemonSet
    metadata:
      name: kube-proxy
      namespace: kube-system
      labels:
        k8s-app: kube-proxy
    spec:
      selector:
        matchLabels:
          k8s-app: kube-proxy
      template:
        metadata:
          labels:
            k8s-app: kube-proxy
        spec:
          priorityClassName: system-node-critical
          hostNetwork: true
          tolerations:
          - operator: Exists
          containers:
          - name: kube-proxy
            image: registry.k8s.io/kube-proxy:v1.30.6
            command:
            - kube-proxy
            - --config=/var/lib/kube-proxy/config.conf
            securityContext:
              privileged: true
            volumeMounts:
            - mountPath: /var/lib/kube-proxy
              name: kube-proxy
            - mountPath: /lib/modules
              name: lib-modules
              readOnly: true
          volumes:
          - name: kube-proxy
            configMap:
              name: kube-proxy
              items:
              - key: config.conf
                path: config.conf
          - name: lib-modules
            hostPath:
              path: /lib/modules
    EOF

- name: Wait for kube-proxy pods Ready
  shell: |
    export KUBECONFIG=/home/vagrant/kubeconfig
    kubectl -n kube-system wait --for=condition=Ready pod -l k8s-app=kube-proxy --timeout=60s
  register: kp_wait
  failed_when: kp_wait.rc != 0


