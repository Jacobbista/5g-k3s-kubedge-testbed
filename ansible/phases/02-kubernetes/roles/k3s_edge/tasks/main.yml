---
# K3s Edge Node Setup
# Install k3s agent on the edge node and join the cluster

- name: "k3s | Check if k3s-agent is already installed"
  stat:
    path: "{{ k3s_install_dir }}/k3s"
  register: k3s_agent_installed
  tags:
    - install
    - k3s

- name: "k3s | Stop existing k3s-agent service if running (cleanup before reinstall)"
  systemd:
    name: k3s-agent
    state: stopped
  ignore_errors: yes
  when: k3s_agent_installed.stat.exists
  tags:
    - cleanup
    - k3s

- name: "k3s | Remove existing k3s-agent installation (cleanup before reinstall)"
  shell: |
    if [ -f /usr/local/bin/k3s-agent-uninstall.sh ]; then
      /usr/local/bin/k3s-agent-uninstall.sh
    else
      echo "k3s-agent uninstall script not found, skipping cleanup"
    fi
  ignore_errors: yes
  when: k3s_agent_installed.stat.exists
  tags:
    - cleanup
    - k3s

- name: "k3s | Get k3s join token from server"
  slurp:
    src: /home/vagrant/k3s_token
  delegate_to: "{{ groups['masters'][0] }}"
  register: k3s_token_content

- name: "k3s | Detect host interface that matches ansible_host (for flannel-iface)"
  shell: |
    ip -4 -o addr show | awk -v IP="{{ ansible_host }}" '$4 ~ IP {print $2; exit}'
  register: k3s_flannel_iface_guess
  changed_when: false

- name: "k3s | Ensure k3s config directory exists"
  file:
    path: "/etc/rancher/k3s"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: "k3s | Persist k3s agent config (flannel-iface + server/token)"
  copy:
    content: |
      server: "https://{{ hostvars[groups['masters'][0]]['ansible_host'] }}:6443"
      token: "{{ k3s_token_content.content | b64decode | trim }}"
      node-ip: "{{ ansible_host }}"
      flannel-iface: "{{ k3s_flannel_iface_guess.stdout | trim }}"
    dest: /etc/rancher/k3s/config.yaml
    owner: root
    group: root
    mode: "0644"

- name: "k3s | Copy k3s token to edge node"
  copy:
    content: "{{ k3s_token_content.content | b64decode | trim }}"
    dest: /home/vagrant/k3s_token
    mode: "0600"
    owner: vagrant
    group: vagrant

- name: "k3s | Download and install k3s agent"
  shell: |
    curl -sfL {{ k3s_install_url }} | {{ ('INSTALL_K3S_VERSION=' ~ k3s_version ~ ' ') if (k3s_version | default('')) | length > 0 else '' }}INSTALL_K3S_CHANNEL={{ k3s_channel }} K3S_URL={{ k3s_master_url }} K3S_TOKEN=$(cat /home/vagrant/k3s_token) sh -
  args:
    creates: "{{ k3s_install_dir }}/k3s"
  tags:
    - install
    - k3s

- name: "k3s | Wait for k3s agent to be ready"
  shell: |
    echo "‚è≥ Waiting for k3s agent to be ready..."
    for i in $(seq 60); do
      if systemctl is-active --quiet k3s-agent; then
        echo "‚úÖ k3s agent is running"
        exit 0
      fi
      echo -n "."
      sleep 2
    done
    echo "‚ùå k3s agent not ready after 120s"
    exit 1
  register: agent_ready
  failed_when: agent_ready.rc != 0
  tags:
    - setup
    - k3s

# KubeEdge cgroup compatibility will be handled in phase 4

- name: "k3s | Label edge node for identification"
  command: kubectl label node {{ hostvars['edge'].inventory_hostname }} node-type=edge node-role.kubernetes.io/edge= --overwrite
  delegate_to: "{{ groups['masters'][0] }}"
  register: edge_label
  changed_when: edge_label.rc == 0
  failed_when: edge_label.rc != 0
  tags:
    - setup
    - labels

# CNI is managed by k3s - no manual setup needed

- name: "Wait for Flannel to be ready on edge (with retries)"
  shell: |
    echo "‚è≥ Waiting for Flannel to be ready on edge..."
    for i in $(seq 120); do
      echo -n "."
      if [ -f /run/flannel/subnet.env ] || ip addr show cni0 >/dev/null 2>&1; then
        if ip addr show flannel.1 >/dev/null 2>&1 || [ -f /run/flannel/subnet.env ]; then
          echo ""
          echo "‚úÖ Flannel indicators present on edge (${i}s)"
          exit 0
        fi
      fi
      sleep 2
    done
    echo ""
    echo "‚ùå Flannel not ready on edge after 240s"
    exit 1
  register: flannel_wait_edge
  failed_when: flannel_wait_edge.rc != 0
  tags:
    - setup
    - flannel
    - wait

- name: "Verify Flannel configuration is correct on edge"
  shell: |
    echo "üîç Verifying Flannel configuration on edge..."

    # flannel.1 may appear slightly after cni0; do not fail if missing here
    if ip addr show flannel.1 >/dev/null 2>&1; then
      echo "‚úÖ flannel.1 interface exists"
      ip addr show flannel.1
    else
      echo "‚ÑπÔ∏è flannel.1 interface not found yet; proceeding because subnet.env/cni0 will confirm"
    fi

    # Check if cni0 interface exists with correct subnet
    if ip addr show cni0 >/dev/null 2>&1; then
      if ip addr show cni0 | grep -q "10.42.*/24"; then
        echo "‚úÖ cni0 interface has correct subnet"
      else
        echo "‚ÑπÔ∏è cni0 present but subnet not yet configured; continuing"
        ip addr show cni0 || true
      fi
    else
      echo "‚ÑπÔ∏è cni0 not present yet; will rely on subnet.env"
    fi

    # Check if subnet.env exists and is correct
    if [ -f /run/flannel/subnet.env ]; then
      echo "‚úÖ Flannel subnet.env exists"
      cat /run/flannel/subnet.env
      if grep -q "FLANNEL_NETWORK=10.42.0.0/16" /run/flannel/subnet.env; then
        echo "‚úÖ Flannel subnet.env has correct network"
      else
        echo "‚ùå Flannel subnet.env has incorrect network"
        exit 1
      fi
    else
      echo "‚ùå Flannel subnet.env missing"
      # Fail only if cni0 is also missing
      if ! ip addr show cni0 >/dev/null 2>&1; then
        echo "‚ùå Both cni0 and subnet.env missing; Flannel not ready"
        exit 1
      fi
    fi

    # Check routing table has correct routes
    if ip addr show cni0 >/dev/null 2>&1; then
      if ip route | grep -q "10.42.*dev cni0"; then
        echo "‚úÖ Routing table has correct Flannel routes"
      else
        echo "‚ÑπÔ∏è Routing table for cni0 not yet populated; continuing"
        ip route | grep -E "10\.42|flannel" || true
      fi
    fi

    echo "‚úÖ Flannel configuration verified successfully on edge"
  register: flannel_verify_edge
  failed_when: flannel_verify_edge.rc != 0
  tags:
    - setup
    - flannel
    - verification
