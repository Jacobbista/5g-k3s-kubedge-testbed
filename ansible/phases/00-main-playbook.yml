---
# MAIN PLAYBOOK - 5G KUBERNETES TESTBED
# Primary orchestrator that executes all phases in sequence with validation

- name: "üöÄ 5G KUBERNETES TESTBED DEPLOYMENT"
  hosts: localhost
  gather_facts: yes
  vars:
    deployment_start_time: "{{ ansible_date_time.iso8601 }}"
    deployment_t0: "{{ lookup('pipe','date +%s') | int }}"
  tasks:
    - name: "Deps | Enable Ubuntu Universe on master"
      become: yes
      apt_repository:
        repo: "deb http://archive.ubuntu.com/ubuntu jammy universe"
        state: present
      delegate_to: "{{ groups['masters'][0] }}"
      run_once: true
      tags:
        - deps

    - name: "Deps | Update apt cache on master"
      become: yes
      apt:
        update_cache: yes
        cache_valid_time: 3600
        force_apt_get: yes
      delegate_to: "{{ groups['masters'][0] }}"
      run_once: true
      tags:
        - deps

    - name: "Deps | Ensure python3-pip on master"
      become: yes
      apt:
        name: python3-pip
        state: present
        update_cache: no
        force_apt_get: yes
      delegate_to: "{{ groups['masters'][0] }}"
      run_once: true
      tags:
        - deps

    - name: "Deps | Ensure Python Kubernetes client on master"
      become: yes
      pip:
        name: "kubernetes>=29.0.0"
        executable: pip3
      delegate_to: "{{ groups['masters'][0] }}"
      run_once: true
      tags:
        - deps
    - name: "Display deployment phases and start time"
      debug:
        msg: |
          üöÄ 5G KUBERNETES TESTBED DEPLOYMENT
          ====================================
          Start Time: {{ deployment_start_time }}

          Deployment phases:
          1Ô∏è‚É£  Infrastructure Setup
          2Ô∏è‚É£  Kubernetes Cluster (k3s)
          3Ô∏è‚É£  KubeEdge Integration
          4Ô∏è‚É£  Overlay Network (OVS + Multus)
          5Ô∏è‚É£  5G Core Network Functions
          6Ô∏è‚É£  UERANSIM & MEC

          To run a single phase:
          ansible-playbook phases/0X-phase-name/playbook.yml

- name: "PHASE 1: t0"
  hosts: localhost
  gather_facts: no
  tags:
    - phase1
    - infrastructure
  tasks:
    - set_fact:
        phase1_t0: "{{ lookup('pipe','date +%s') | int }}"

- name: "PHASE 1: Infrastructure Setup"
  import_playbook: 01-infrastructure/playbook.yml
  vars:
    phase_name: "Infrastructure Setup"
    phase_number: 1
  tags:
    - phase1
    - infrastructure

- name: "PHASE 1: Validate Infrastructure Setup"
  hosts: localhost
  gather_facts: no
  tags:
    - phase1
    - infrastructure
  tasks:
    - name: "Validation | Check if all nodes are reachable"
      wait_for_connection:
        timeout: 60
      delegate_to: "{{ item }}"
      loop: "{{ groups['all'] | difference(['ansible']) }}"
      register: connectivity_check
      failed_when: connectivity_check.failed | default(false)

    - debug:
        msg: "‚úÖ PHASE 1: Infrastructure Setup completed successfully"

    - name: "PHASE 1: duration"
      debug:
        msg: >-
          ‚è±Ô∏è PHASE 1 took
          {{
            ((lookup('pipe','date +%s') | int) - (phase1_t0|default(0)|int))
            | int
          }}s
      when: phase1_t0 is defined

- name: "PHASE 2: t0"
  hosts: localhost
  gather_facts: no
  tags:
    - phase2
    - kubernetes
  tasks:
    - set_fact:
        phase2_t0: "{{ lookup('pipe','date +%s') | int }}"

- name: "PHASE 2: Kubernetes Cluster Setup"
  import_playbook: 02-kubernetes/playbook.yml
  vars:
    phase_name: "Kubernetes Cluster Setup"
    phase_number: 2
  tags:
    - phase2
    - kubernetes

- name: "PHASE 2: Validate Kubernetes Cluster"
  hosts: masters
  gather_facts: no
  become: no
  tags:
    - phase2
    - kubernetes
  tasks:
    - name: "Validation | Get Nodes via kubernetes.core"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Node
        kubeconfig: "/home/vagrant/kubeconfig"
      register: nodes_info

    - name: "Validation | Assert 2 Ready nodes (master + worker)"
      assert:
        that:
          - (nodes_info.resources | length) >= 2
          - (nodes_info.resources | selectattr('status', 'defined') | list | length) >= 2

    - debug:
        msg: "‚úÖ PHASE 2: Kubernetes Cluster Setup completed successfully"

- name: "PHASE 2: Duration Summary"
  hosts: localhost
  gather_facts: no
  tags:
    - phase2
    - kubernetes
  tasks:
    - name: "PHASE 2: duration"
      debug:
        msg: >-
          ‚è±Ô∏è PHASE 2 took
          {{
            ((lookup('pipe','date +%s') | int) - (phase2_t0|default(0)|int))
            | int
          }}s
      when: phase2_t0 is defined

- name: "PHASE 3: t0"
  hosts: localhost
  gather_facts: no
  tags:
    - phase3
    - kubeedge
  tasks:
    - set_fact:
        phase3_t0: "{{ lookup('pipe','date +%s') | int }}"

- name: "PHASE 3: KubeEdge Integration"
  import_playbook: 03-kubeedge/playbook.yml
  vars:
    phase_name: "KubeEdge Integration"
    phase_number: 3
  tags:
    - phase3
    - kubeedge

- name: "PHASE 3: Validate KubeEdge Integration"
  hosts: masters
  gather_facts: no
  tags:
    - phase3
    - kubeedge
  tasks:
    - name: "Validation | Get KubeEdge pods"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: kubeedge
        kubeconfig: "/home/vagrant/kubeconfig"
      register: kubeedge_pods_info

    - name: "Validation | Assert some KubeEdge pods are Running"
      assert:
        that:
          - kubeedge_pods_info.resources | selectattr('status.phase','equalto','Running') | list | length > 0

    - name: "Validation | Get all nodes (should now include edge via KubeEdge)"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Node
        kubeconfig: "/home/vagrant/kubeconfig"
      register: all_nodes_info

    - name: "Validation | Assert 3 nodes total (master + worker + edge)"
      assert:
        that:
          - (all_nodes_info.resources | length) >= 3
          - (all_nodes_info.resources | selectattr('status', 'defined') | list | length) >= 3

    - debug:
        msg: "‚úÖ PHASE 3: KubeEdge Integration completed successfully ({{ all_nodes_info.resources | length }} nodes total)"

- name: "PHASE 3: Duration Summary"
  hosts: localhost
  gather_facts: no
  tags:
    - phase3
    - kubeedge
  tasks:
    - name: "PHASE 3: duration"
      debug:
        msg: >-
          ‚è±Ô∏è PHASE 3 took
          {{
            ((lookup('pipe','date +%s') | int) - (phase3_t0|default(0)|int))
            | int
          }}s
      when: phase3_t0 is defined

- name: "PHASE 4: t0"
  hosts: localhost
  gather_facts: no
  tags:
    - phase4
    - overlay
    - network
  tasks:
    - set_fact:
        phase4_t0: "{{ lookup('pipe','date +%s') | int }}"

- name: "PHASE 4: Overlay Network Setup"
  import_playbook: 04-overlay-network/playbook.yml
  vars:
    phase_name: "Overlay Network Setup"
    phase_number: 4
  tags:
    - phase4
    - overlay
    - network

- name: "PHASE 4: Validate Overlay Network"
  hosts: masters
  gather_facts: no
  tags:
    - phase4
    - overlay
    - network
  tasks:
    - name: "Validation | Get OVS DaemonSets"
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: DaemonSet
        namespace: kube-system
        kubeconfig: "/home/vagrant/kubeconfig"
      register: ovs_daemonsets_info

    - name: "Validation | Assert OVS DaemonSets ready"
      assert:
        that:
          # We expect one Ready pod for each DS (worker and edge) ‚Üí sum == 2
          - (
            ovs_daemonsets_info.resources
            | selectattr('metadata.name', 'match', 'ds-net-setup.*')
            | map(attribute='status.numberReady')
            | map('int')
            | sum
            ) == 2

    - debug:
        msg: "‚úÖ PHASE 4: Overlay Network Setup completed successfully"

- name: "PHASE 4: Duration Summary"
  hosts: localhost
  gather_facts: no
  tags:
    - phase4
    - overlay
    - network
  tasks:
    - name: "PHASE 4: duration"
      debug:
        msg: >-
          ‚è±Ô∏è PHASE 4 took
          {{
            ((lookup('pipe','date +%s') | int) - (phase4_t0|default(0)|int))
            | int
          }}s
      when: phase4_t0 is defined

- name: "PHASE 5: t0"
  hosts: localhost
  gather_facts: no
  tags:
    - phase5
    - 5g
    - core
  tasks:
    - set_fact:
        phase5_t0: "{{ lookup('pipe','date +%s') | int }}"

- name: "PHASE 5: 5G Core Network Functions"
  import_playbook: 05-5g-core/playbook.yml
  vars:
    phase_name: "5G Core Network Functions"
    phase_number: 5
  tags:
    - phase5
    - 5g
    - core

- name: "PHASE 5: Validate 5G Core Network Functions"
  hosts: masters
  gather_facts: no
  tags:
    - phase5
    - 5g
    - core
  tasks:
    - name: "Validation | Get 5G Core pods"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: 5g
        kubeconfig: "/home/vagrant/kubeconfig"
      register: core_pods_info

    - name: "Validation | Assert 5G Core pods threshold"
      assert:
        that:
          - core_pods_info.resources | selectattr('status.phase','equalto','Running') | list | length >= 5

    - debug:
        msg: "‚úÖ PHASE 5: 5G Core Network Functions completed successfully"

- name: "PHASE 5: Duration Summary"
  hosts: localhost
  gather_facts: no
  tags:
    - phase5
    - 5g
    - core
  tasks:
    - name: "PHASE 5: duration"
      debug:
        msg: >-
          ‚è±Ô∏è PHASE 5 took
          {{
            ((lookup('pipe','date +%s') | int) - (phase5_t0|default(0)|int))
            | int
          }}s
      when: phase5_t0 is defined

- name: "PHASE 6: t0"
  hosts: localhost
  gather_facts: no
  tags:
    - phase6
    - ueransim
    - mec
  tasks:
    - set_fact:
        phase6_t0: "{{ lookup('pipe','date +%s') | int }}"

- name: "PHASE 6: UERANSIM & MEC Setup"
  import_playbook: 06-ueransim-mec/playbook.yml
  vars:
    phase_name: "UERANSIM & MEC Setup"
    phase_number: 6
  tags:
    - phase6
    - ueransim
    - mec

- name: "PHASE 6: Validate UERANSIM & MEC Setup"
  hosts: masters
  gather_facts: no
  tags:
    - phase6
    - ueransim
    - mec
  tasks:
    - name: "Validation | Get UERANSIM pods"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: 5g
        kubeconfig: "/home/vagrant/kubeconfig"
      register: ueransim_pods_info

    - name: "Validation | Compute gNB Running count"
      set_fact:
        gnb_running_count: >-
          {{
            ueransim_pods_info.resources | default([])
            | selectattr('status.phase','equalto','Running')
            | selectattr('metadata.labels.app','defined')
            | selectattr('metadata.labels.app','equalto','gnb')
            | list | length
          }}

    - name: "Validation | Compute UE Running count"
      set_fact:
        ue_running_count: >-
          {{
            ueransim_pods_info.resources | default([])
            | selectattr('status.phase','equalto','Running')
            | selectattr('metadata.labels.app','defined')
            | selectattr('metadata.labels.app','equalto','ue')
            | list | length
          }}

    - name: "Validation | Assert gNB Running >= 1"
      assert:
        that:
          - (gnb_running_count | int) >= 1

    - name: "Validation | Assert UE Running >= 1"
      assert:
        that:
          - (ue_running_count | int) >= 1

    - debug:
        msg: "‚úÖ PHASE 6: UERANSIM & MEC Setup completed successfully"

- name: "PHASE 6: Duration Summary"
  hosts: localhost
  gather_facts: no
  tags:
    - phase6
    - ueransim
    - mec
  tasks:
    - name: "PHASE 6: duration"
      debug:
        msg: >-
          ‚è±Ô∏è PHASE 6 took
          {{
            ((lookup('pipe','date +%s') | int) - (phase6_t0|default(0)|int))
            | int
          }}s
      when: phase6_t0 is defined

# Phase 7 is optional - run separately with:
# ansible-playbook phases/07-observability/playbook.yml
- name: "PHASE 7: Observability Stack (Optional)"
  import_playbook: 07-observability/playbook.yml
  vars:
    phase_name: "Observability Stack"
    phase_number: 7
  tags:
    - phase7
    - observability
    - monitoring
    - never  # Skip by default, run with --tags phase7

- name: "üéâ DEPLOYMENT COMPLETED SUCCESSFULLY"
  hosts: localhost
  gather_facts: no
  tasks:
    - set_fact:
        deployment_t1: "{{ lookup('pipe','date +%s') | int }}"

    - name: "Final | Display deployment completion"
      debug:
        msg: |
          üéâ 5G KUBERNETES TESTBED DEPLOYMENT COMPLETED
          =============================================
          Start Time: {{ deployment_start_time | default('N/A') }}
          End Time:   {{ ansible_date_time.iso8601 }}
          Total:      {{ ((deployment_t1|default(0)|int) - (deployment_t0|default(0)|int)) | int }}s

          All phases completed successfully:
          ‚úÖ Infrastructure Setup
          ‚úÖ Kubernetes Cluster (k3s)
          ‚úÖ KubeEdge Integration
          ‚úÖ Overlay Network (OVS + Multus)
          ‚úÖ 5G Core Network Functions
          ‚úÖ UERANSIM & MEC

          Optional phases:
          ‚ÑπÔ∏è  Observability Stack (run: ansible-playbook phases/07-observability/playbook.yml)
      when: deployment_t0 is defined and deployment_t1 is defined
