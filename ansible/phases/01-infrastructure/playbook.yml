---
# FASE 1: INFRASTRUCTURE SETUP
# Configurazione base di rete, pacchetti e connettività tra nodi

- name: "FASE 1: Infrastructure Setup"
  hosts: all:!ansible
  become: yes
  tasks:
    - name: "Infrastructure | Install system packages (chrony, iptables, net-tools)"
      apt: 
        name: [chrony, iptables, netfilter-persistent, net-tools, curl, wget, jq]
        state: present
        update_cache: yes

    - name: "Infrastructure | Install OVS only on worker and edge nodes"
      apt: 
        name: [openvswitch-switch]
        state: present
      when: inventory_hostname in groups['workers'] or inventory_hostname in groups['edges']

    - name: "Infrastructure | Enable and start chrony service"
      systemd:
        name: chrony
        enabled: yes
        state: started

    - name: "Infrastructure | Enable IP forwarding for network connectivity"
      sysctl:
        name: net.ipv4.ip_forward
        value: '1'
        state: present
        reload: yes

    - name: "Infrastructure | Configure persistent iptables rules for inter-node communication"
      iptables:
        table: filter
        chain: FORWARD
        in_interface: eth1
        jump: ACCEPT
        comment: "Allow forwarding from eth1"
      when: ansible_default_ipv4.interface == "eth1"

    - name: "Infrastructure | Configure persistent iptables rules for outbound traffic"
      iptables:
        table: filter
        chain: FORWARD
        out_interface: eth1
        jump: ACCEPT
        comment: "Allow forwarding to eth1"
      when: ansible_default_ipv4.interface == "eth1"

    - name: "Infrastructure | Configure persistent NAT rules for internal traffic"
      iptables:
        table: nat
        chain: POSTROUTING
        out_interface: eth1
        jump: MASQUERADE
        comment: "NAT for internal traffic"
      when: ansible_default_ipv4.interface == "eth1"

    - name: "Infrastructure | Save iptables rules to make them persistent"
      command: netfilter-persistent save
      changed_when: true
      when: ansible_default_ipv4.interface == "eth1"

    - name: "Infrastructure | Configure hostname resolution using inventory data"
      blockinfile:
        path: /etc/hosts
        marker: "# {mark} ANSIBLE MANAGED - 5G Testbed Hosts"
        block: |
          {{ hostvars[groups['masters'][0]]['ansible_host'] }} {{ groups['masters'][0] }}
          {{ hostvars[groups['workers'][0]]['ansible_host'] }} {{ groups['workers'][0] }}
          {{ hostvars[groups['edges'][0]]['ansible_host'] }} {{ groups['edges'][0] }}
        create: yes

    - name: "Infrastructure | Test connectivity between nodes using inventory IPs"
      command: ping -c 1 -W 2 "{{ hostvars[item]['ansible_host'] }}"
      loop: "{{ groups['all'] | difference([inventory_hostname]) }}"
      register: connectivity_test
      changed_when: false
      failed_when: connectivity_test.rc != 0

    - name: "Infrastructure | Display connectivity test results"
      debug:
        msg: "✅ {{ inventory_hostname }} -> {{ item.item }}: OK"
      loop: "{{ connectivity_test.results }}"
      when: item.rc == 0

    - name: "Infrastructure | Fail if any connectivity test failed"
      fail:
        msg: "❌ CRITICAL: {{ item.item }} not reachable from {{ inventory_hostname }}"
      loop: "{{ connectivity_test.results }}"
      when: item.rc != 0
