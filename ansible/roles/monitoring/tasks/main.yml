---
- name: Install Kubernetes Dashboard
  command: kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml
  register: dashboard_install
  changed_when: dashboard_install.rc == 0
  failed_when: dashboard_install.rc != 0

- name: Wait for dashboard to be ready
  command: kubectl wait --for=condition=ready pod -l k8s-app=kubernetes-dashboard -n kubernetes-dashboard --timeout=300s
  register: dashboard_wait
  changed_when: dashboard_wait.rc == 0
  failed_when: dashboard_wait.rc != 0

- name: Create dashboard admin user
  template:
    src: dashboard-admin.yaml.j2
    dest: /tmp/dashboard-admin.yaml
    mode: '0644'

- name: Apply dashboard admin user
  command: kubectl apply -f /tmp/dashboard-admin.yaml
  register: dashboard_admin_apply
  changed_when: dashboard_admin_apply.rc == 0
  failed_when: dashboard_admin_apply.rc != 0

- name: Install metrics server
  command: kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
  register: metrics_install
  changed_when: metrics_install.rc == 0
  failed_when: metrics_install.rc != 0

- name: Wait for metrics server to be ready
  command: kubectl wait --for=condition=ready pod -l k8s-app=metrics-server -n kube-system --timeout=300s
  register: metrics_wait
  changed_when: metrics_wait.rc == 0
  failed_when: metrics_wait.rc != 0

- name: Show monitoring status
  debug:
    msg: 
      - "Kubernetes Dashboard installed successfully"
      - "Metrics Server installed successfully"
      - "Access dashboard: kubectl port-forward -n kubernetes-dashboard service/kubernetes-dashboard 8080:443"
