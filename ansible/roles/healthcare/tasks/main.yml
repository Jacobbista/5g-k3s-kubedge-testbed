---
- name: Create healthcare namespace
  command: kubectl create namespace healthcare --dry-run=client -o yaml | kubectl apply -f -
  register: namespace_create
  changed_when: namespace_create.rc == 0
  failed_when: namespace_create.rc != 0

- name: Deploy cardiac monitor service
  template:
    src: cardiac-monitor.yaml.j2
    dest: /tmp/cardiac-monitor.yaml
    mode: '0644'

- name: Apply cardiac monitor
  command: kubectl apply -f /tmp/cardiac-monitor.yaml
  register: cardiac_monitor_apply
  changed_when: cardiac_monitor_apply.rc == 0
  failed_when: cardiac_monitor_apply.rc != 0

- name: Deploy ventilator service
  template:
    src: ventilator.yaml.j2
    dest: /tmp/ventilator.yaml
    mode: '0644'

- name: Apply ventilator
  command: kubectl apply -f /tmp/ventilator.yaml
  register: ventilator_apply
  changed_when: ventilator_apply.rc == 0
  failed_when: ventilator_apply.rc != 0

- name: Deploy defibrillator service
  template:
    src: defibrillator.yaml.j2
    dest: /tmp/defibrillator.yaml
    mode: '0644'

- name: Apply defibrillator
  command: kubectl apply -f /tmp/defibrillator.yaml
  register: defibrillator_apply
  changed_when: defibrillator_apply.rc == 0
  failed_when: defibrillator_apply.rc != 0

- name: Deploy patient monitoring dashboard
  template:
    src: patient-dashboard.yaml.j2
    dest: /tmp/patient-dashboard.yaml
    mode: '0644'

- name: Apply patient dashboard
  command: kubectl apply -f /tmp/patient-dashboard.yaml
  register: dashboard_apply
  changed_when: dashboard_apply.rc == 0
  failed_when: dashboard_apply.rc != 0

- name: Wait for healthcare services to be ready
  command: kubectl wait --for=condition=ready pod -l app=healthcare -n healthcare --timeout=300s
  register: healthcare_wait
  changed_when: healthcare_wait.rc == 0
  failed_when: healthcare_wait.rc != 0

- name: Show healthcare services status
  command: kubectl get pods -n healthcare
  register: healthcare_status
  changed_when: false

- name: Display healthcare status
  debug:
    msg: "{{ healthcare_status.stdout_lines }}"

- name: Show healthcare services
  command: kubectl get svc -n healthcare
  register: healthcare_services
  changed_when: false

- name: Display healthcare services
  debug:
    msg: "{{ healthcare_services.stdout_lines }}"
