---
- name: Install KubeEdge cloudcore
  shell: |
    wget https://github.com/kubeedge/kubeedge/releases/download/v1.15.0/kubeedge-v1.15.0-linux-amd64.tar.gz
    tar -xzf kubeedge-v1.15.0-linux-amd64.tar.gz
    sudo cp kubeedge-v1.15.0-linux-amd64/cloud/cloudcore/cloudcore /usr/local/bin/
    sudo chmod +x /usr/local/bin/cloudcore
  args:
    creates: /usr/local/bin/cloudcore
  changed_when: false

- name: Create KubeEdge namespace
  command: kubectl create namespace kubeedge --dry-run=client -o yaml
  register: namespace_yaml
  changed_when: false

- name: Apply KubeEdge namespace
  shell: "echo '{{ namespace_yaml.stdout }}' | kubectl apply -f - --kubeconfig=/etc/kubernetes/admin.conf"
  register: namespace_create
  changed_when: namespace_create.rc == 0
  failed_when: namespace_create.rc != 0

- name: Generate KubeEdge cloudcore configuration
  template:
    src: cloudcore-config.yaml.j2
    dest: /tmp/cloudcore-config.yaml
    mode: '0644'

- name: Apply KubeEdge cloudcore configuration
  command: kubectl apply -f /tmp/cloudcore-config.yaml --kubeconfig=/etc/kubernetes/admin.conf
  register: cloudcore_apply
  changed_when: cloudcore_apply.rc == 0
  failed_when: cloudcore_apply.rc != 0

- name: Wait for KubeEdge cloudcore to be ready
  command: kubectl wait --for=condition=ready pod -l app=cloudcore -n kubeedge --timeout=300s --kubeconfig=/etc/kubernetes/admin.conf
  register: cloudcore_wait
  changed_when: cloudcore_wait.rc == 0
  failed_when: cloudcore_wait.rc != 0

- name: Generate edge node join token
  shell: kubectl get secret -n kubeedge tokensecret -o jsonpath='{.data.tokendata}' --kubeconfig=/etc/kubernetes/admin.conf | base64 -d
  register: edge_token
  changed_when: false

- name: Save edge token to file
  copy:
    content: "{{ edge_token.stdout }}"
    dest: /tmp/edge-token
    mode: '0644'

- name: Show KubeEdge installation status
  debug:
    msg: "KubeEdge cloudcore successfully installed and configured"
